<div class="poster-rows" aria-hidden="true">
  <div class="row r1"><div class="inner"></div></div>
  <div class="row r2"><div class="inner"></div></div>
  <div class="row r3"><div class="inner"></div></div>
  <div class="row r4"><div class="inner"></div></div>
  <div class="row r5"><div class="inner"></div></div>
  <div class="row r6"><div class="inner"></div></div>
  <div class="row r7"><div class="inner"></div></div>
  <div class="row r8"><div class="inner"></div></div>
  <div class="row r9"><div class="inner"></div></div>
  <div class="row r10"><div class="inner"></div></div>
</div>

<nav class="sidebar" [class.active]="sidebarService.sidebarActive()" [class.no-anim]="sidebarService.suppressAnim()">
  <div class="logo-menu">
    <h2 class="logo">What2Watch</h2>
    <i class="bx bx-menu toggle-button" (click)="sidebarService.toggle()"></i>
  </div>

  <ul class="list">
    <li class="list-item">
      <a (click)="routingService.navigateToHome()">
        <i class="bx bx-home-alt"></i>
        <span class="link-name" style="--i:3;">Home</span>
      </a>
    </li>

    <li class="list-item">
      <a (click)="routingService.navigateToSearchMovies()">
        <i class="bx bx-search"></i>
        <span class="link-name" style="--i:2;">Search</span>
      </a>
    </li>

    <li class="list-item active">
      <a (click)="routingService.navigateToLibrary()">
        <i class='bx  bx-list-ul'></i>
        <span class="link-name" style="--i:1;">Library</span>
      </a>
    </li>

    <li class="list-item">
      <a (click)="routingService.navigateToSummary()">
        <i class='bx bx-bar-chart-alt-2'></i>
        <span class="link-name" style="--i:2;">Summary</span>
      </a>
    </li>

    <li class="list-item">
        <a (click)="routingService.navigateToAccountsPosts(currentUser()!.username)">
            <i class="bx bx-user"></i>
            <span class="link-name" style="--i:3;">Account</span>
        </a>
    </li>

    <li class="list-item">
      <a (click)="routingService.navigateToSettings()">
        <i class="bx bx-cog"></i>
        <span class="link-name" style="--i:4;">Settings</span>
      </a>
    </li>

    <li class="username" *ngIf="currentUser() as cu">
      <p class="link-name" style="--i:1;">Signed in as:</p>
      <p class="link-name" style="--i:1;">{{ cu.username }}</p>
    </li>
  </ul>
</nav>

<div class="container" [class.active]="sidebarService.sidebarActive() === false" [class.no-anim]="sidebarService.suppressAnim()">
  <!-- Loading State -->
  <div class="left-side loading-shimmer" *ngIf="isLoadingRatings()">
    <div class="shimmer-poster"></div>

    <div class="shimmer-content">
      <div class="shimmer-line"></div>
      <div class="shimmer-line short"></div>
      <div class="shimmer-line medium"></div>
    </div>
  </div>

  <!-- Active Film -->
  <div class="left-side" *ngIf="!isLoadingRatings() && activeFilm as af; else noSelection">
    <div class="top-information" *ngIf="af.date_rated">
      <img
        class="film-poster"
        [src]="posterSrc"
        [attr.alt]="activeFilm.title || 'Poster'"
        (error)="setFallback($event)"
        loading="lazy"
        decoding="async"
      />

      <div class="film-left">
        <div class="film-scroll">
          <p class="title">{{ activeFilm.title }}</p>
          <p class="release" *ngIf="activeFilm.release_date">{{ formatLongDate(activeFilm.release_date) }}</p>

          <div class="meta">
            <span class="badge" *ngIf="activeFilm.rated">{{ activeFilm.rated }}</span>

            <span class="badge" *ngIf="activeFilm.genres.length">
              {{ activeFilm.genres.join(' • ') }}
            </span>
          </div>
        </div>

        <div class="film-counts">
          <div class="count" *ngIf="count1Num !== 0 || count1Label !== 'N/A'">
            <div class="count-num">{{ count1Num }}</div>
            <div class="count-label">{{ count1Label }}</div>
          </div>

          <div class="count" *ngIf="count2Num !== 0 || count2Label !== 'N/A'">
            <div class="count-num">{{ count2Num }}</div>
            <div class="count-label">{{ count2Label }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-information" *ngIf="af.date_rated">
      <div class="film-ratings">
        <div class="rating-titles">
          <p>Acting:</p>
          <p>Visuals:</p>
          <p>Story:</p>
          <p>Pacing:</p>
          <p>{{ af.media_type === 'series' ? 'Length:' : 'Climax:' }}</p>
          <p>Ending:</p>
          <p class="ovr-rating">Total:</p>
        </div>

        <div class="rating-scores">
          <p>{{ af.criteria.acting }}</p>
          <p>{{ af.criteria.visuals }}</p>
          <p>{{ af.criteria.story }}</p>
          <p>{{ af.criteria.pacing }}</p>
          <p>{{ af.media_type === 'series' ? $any(af.criteria).length : $any(af.criteria).climax }}</p>          
          <p>{{ af.criteria.ending }}</p>
          <p class="ovr-rating">{{ af.rating }}</p>
        </div>
      </div>

      <div class="date-rated">
        <p>Date Rated: {{ formatLongDate(af.date_rated) }}</p>
        <button type="button" class="button" (click)="onEdit(af)">Edit Rating</button>
        <button type="button" class="button" (click)="openConfirm(af)">Delete Rating</button>
      </div>
    </div>
  </div>

  <ng-template #noSelection>
    <div class="left-side empty" *ngIf="!isLoadingRatings()">
      <p class="empty-text">You don't have any ratings yet</p>
      <button type="button" class="empty-button" (click)="this.routingService.navigateToSearchMovies()">
        Find Something To Rate
      </button>
    </div>
  </ng-template>

  <div class="rated-films-container">
    <div class="seach-bar" *ngIf="usersRatedList().length > 0">
      <div class="input-box">
        <input
          type="text"
          [ngModel]="searchInput()"
          (ngModelChange)="searchInput.set($event)"
          name="searchInput"
          autocomplete="off"
          aria-label="Search rated items"
          placeholder=" "
        />

        <label>What are you looking for?</label>

        <button
          type="button"
          class="filter-btn"
          (click)="toggleFilters()"
          aria-haspopup="true"
          [attr.aria-expanded]="filtersOpen()"
          title="Filters"
        >
          <i class="bx bx-filter-alt"></i>
        </button>

        <div class="filter-panel" *ngIf="filtersOpen()" (click)="$event.stopPropagation()">
          <div class="filter-row">
            <span class="filter-heading">Media Type</span>

            <div class="select-multi" [class.open]="mediaTypeOpen()">
              <button type="button" class="select-trigger" (click)="toggleMediaTypeOpen()">
                <span>{{ mediaTypeLabel() }}</span>
                <i class="bx bx-chevron-down chevron" aria-hidden="true"></i>
              </button>

              <div class="select-menu" *ngIf="mediaTypeOpen()">
                <div
                  class="option"
                  (click)="toggleMediaType('movie')"
                  [class.selected]="selectedMediaTypes().has('movie')"
                  role="option"
                  [attr.aria-selected]="selectedMediaTypes().has('movie')"
                >
                  <span class="tickbox" aria-hidden="true"></span>
                  <span class="label">Movies</span>
                </div>

                <div
                  class="option"
                  (click)="toggleMediaType('series')"
                  [class.selected]="selectedMediaTypes().has('series')"
                  role="option"
                  [attr.aria-selected]="selectedMediaTypes().has('series')"
                >
                  <span class="tickbox" aria-hidden="true"></span>
                  <span class="label">Shows</span>
                </div>

                <div class="select-actions">
                  <button type="button" (click)="clearMediaTypes()">Clear</button>
                  <button type="button" (click)="mediaTypeOpen.set(false)">Done</button>
                </div>
              </div>
            </div>
          </div>

          <div class="filter-row">
            <span class="filter-heading">Sort by</span>

            <div class="segmented">
              <button type="button" 
                      [class.active]="sortKey()==='dateRated'" 
                      (click)="setSort('dateRated')">
                Date Rated
              </button>
              
              <button type="button" 
                      [class.active]="sortKey()==='rating'" 
                      (click)="setSort('rating')">
                Overall Rating
              </button>
              
              <button type="button" 
                      [class.active]="sortKey()==='runtime'" 
                      [class.disabled]="!canSortByRuntime()"
                      [attr.title]="runtimeTooltip()"
                      (click)="setSort('runtime')">
                Runtime
              </button>
              
              <button type="button" 
                      [class.active]="sortKey()==='episodes'" 
                      [class.disabled]="!canSortByEpisodes()"
                      [attr.title]="episodesTooltip()"
                      (click)="setSort('episodes')">
                Episodes
              </button>
              
              <button type="button" 
                      [class.active]="sortKey()==='title'" 
                      (click)="setSort('title')">
                Title
              </button>
            </div>
          </div>

          <div class="filter-row direction-row">
            <span class="filter-heading">Direction</span>
            
            <div class="direction-split">
              <button type="button" [class.active]="sortDirection()==='asc'" (click)="setDirection('asc')">Ascending</button>
              <button type="button" [class.active]="sortDirection()==='desc'" (click)="setDirection('desc')">Descending</button>
            </div>
          </div>

          <div class="filter-row">
            <span class="filter-heading">Genre</span>

            <div class="select-multi" [class.open]="genresOpen()">
              <button type="button" class="select-trigger" (click)="toggleGenresOpen()">
                <span>{{ genresLabel() }}</span>
                <i class="bx bx-chevron-down chevron" aria-hidden="true"></i>
              </button>

              <div class="select-menu" *ngIf="genresOpen()">
                <div
                  class="option"
                  *ngFor="let g of userGenres().slice(1)"
                  (click)="toggleGenre(g)"
                  [class.selected]="selectedGenres().has(g)"
                  role="option"
                  [attr.aria-selected]="selectedGenres().has(g)"
                >
                  <span class="tickbox" aria-hidden="true"></span>
                  <span class="label">{{ g }}</span>
                </div>

                <div class="select-actions">
                  <button type="button" (click)="clearGenres()">Clear</button>
                  <button type="button" (click)="genresOpen.set(false)">Done</button>
                </div>
              </div>
            </div>
          </div>

          <div class="filter-row">
            <span class="filter-heading">Rated</span>

            <div class="select-multi" [class.open]="ratedOpen()">
              <button type="button" class="select-trigger" (click)="toggleRatedOpen()">
                <span>{{ ratedLabel() }}</span>
                <i class="bx bx-chevron-down chevron" aria-hidden="true"></i>
              </button>

              <div class="select-menu" *ngIf="ratedOpen()">
                <div
                  class="option"
                  *ngFor="let r of userRatedValues().slice(1)"
                  (click)="toggleRated(r)"
                  [class.selected]="selectedRateds().has(r)"
                  role="option"
                  [attr.aria-selected]="selectedRateds().has(r)"
                >
                  <span class="tickbox" aria-hidden="true"></span>
                  <span class="label">{{ r }}</span>
                </div>

                <div class="select-actions">
                  <button type="button" (click)="clearRateds()">Clear</button>
                  <button type="button" (click)="ratedOpen.set(false)">Done</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="scroll-box" #scrollBox>
      <div class="rated-films" *ngIf="filteredRatedFilms().length; else noRatedMovies">
        <div class="rated-film" *ngFor="let film of filteredRatedFilms(); trackBy: trackByPostId" (click)="onRatedFilmClicked(film)" [attr.data-postid]="film.id">
          <app-rated-film
            [ratedFilm]="film" 
            [active]="film.id === activeFilm?.id" 
            [attr.aria-selected]="film.id === activeFilm?.id">
          </app-rated-film>
        </div>
      </div>

      <ng-template #noRatedMovies>
        <div class="no-rated-movies"></div>
      </ng-template>
    </div>
  </div>

  <div
    class="modal-backdrop"
    *ngIf="confirmOpen()"
    (click)="closeConfirm()"
    aria-hidden="true">
  </div>

  <div
    class="modal"
    *ngIf="confirmOpen()"
    role="dialog"
    aria-modal="true"
    aria-labelledby="confirmTitle"
    (click)="$event.stopPropagation()">

    <h3 id="confirmTitle" class="modal-title">
      Are you sure you want to delete your rating for
      <span class="modal-title-film">{{ confirmTarget()?.title }}</span>?
    </h3>

    <p class="modal-body">
      This will delete your post as well.
    </p>

    <div class="modal-actions">
      <button type="button" class="btn btn-danger" (click)="confirmDelete()">
        Yes, I’m sure
      </button>
      <button type="button" class="btn btn-ghost" (click)="closeConfirm()">
        Never mind
      </button>
    </div>
  </div>
</div>
